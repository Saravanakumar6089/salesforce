<!DOCTYPE html>
<html>
<head>
    <title>Client Data Collection Form</title>
</head>
<body>
    <form id="dataForm">
        <label for="phone">Contact Number:</label><br>
        <input type="text" id="phone" name="phone" required><br><br>
        <label >Preferred Time to Contact</label><br>
        <label for="preferred_time_start">From:</label><br>
        <input type ="time" id="preferred_time_start" name="preferred_time_start" required><br><br>
        <label for="preferred_time_end">To:</label><br>
        <input type ="time" id="preferred_time_end" name="preferred_time_end" required><br><br>
        <input type="submit" value="Submit">
    </form>

    <script>
        const clientId = '3MVG9WVXk15qiz1LWN2jKApNTQGjdb840JJ._pDvgj_oi7q4yUEyu69wvZ.cEQgx1KQyMIEOGenU1PIs.5R1l';
        const clientSecret = 'D6EFF72C30557ED27690EDDA1B977077448A677C2A4BBB231FB9CA8AEF875C31';
        const refreshToken = '5Aep861iCXbTx3lghRD4bxys_NofOs2t7.TluBAVyf7OLT4PieCZXb3DuzuAHkJtQ6q6bX82q.L.cLOM10G4IRG';
        const tokenUrl = 'https://citi-5d-dev-ed.develop.my.salesforce.com/services/oauth2/token';
        const apiUrl = 'https://citi-5d-dev-ed.develop.my.salesforce.com/services/oauth2/authorize';
        let accessToken;
        function getNewAccessToken() {
            fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'grant_type': 'refresh_token',
                    'client_id': clientId,
                    'client_secret': clientSecret,
                    'refresh_token': refreshToken
                })
            }).then(resp=>{
                if (resp.ok) {
                    alert('Token refresh successful');
                    const tokendata = JSON.stringify(resp);
                    if (resp.ok) {
                        accessToken = tokendata.access_token.toString();
                    } else {
                        console.error('Error refreshing token:', tokendata);
                    }
                } else {
                    alert(response.statusText+'Form submission failed');
                }

            });
            
            
        }

        document.getElementById('dataForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const data = {
                phone: document.getElementById('phone').value,
                preferred_time_start: document.getElementById('preferred_time_start').value,
                preferred_time_end: document.getElementById('preferred_time_end').value
            };

            if (!accessToken) {
                getNewAccessToken();
            }        

            fetch('https://citi-5d-dev-ed.develop.my.salesforce.com/services/apexrest/FormSubmission', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer '+accessToken
                },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    alert('Form submitted successfully');
                } else {
                    
                    alert(response.statusText+'Form submission failed');
                }
            });
        });
    </script>
</body>
</html>
